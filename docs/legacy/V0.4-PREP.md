# v0.4 Prep: Core-First Suggestion Loop

## Goal
v0.4는 UI보다 먼저 `추천 -> 시도 -> 학습` 루프를 도메인/호스트/테스트 레벨에서 고정한다.
Projection UI는 이미 계산된 추천 결과를 표시만 한다.

## Scope
- Include:
  - MEL 액션/상태 계약 추가
  - Host 추천 effect 구현
  - Projection read model 확장
  - Extension command/panel wiring
  - 회귀 테스트 추가
- Exclude:
  - 자동 tactic 실행/Lean 편집 반영
  - 복잡한 UI 인터랙션(정렬/페이지네이션 고도화)

## Proposed Contracts

### MEL state
```mel
type SuggestionEntry = {
  nodeId: string,
  tacticKey: string,
  score: number,
  sampleSize: number,
  successRate: number,
  sourceCategory: ErrorCategory | null,
  generatedAt: number
}

type SuggestionState = {
  version: string,
  byNode: Record<string, Array<SuggestionEntry>>,
  updatedAt: number | null
}
```

### MEL actions
```mel
action attempt_suggest(fileUri: string, nodeId: string)
action suggestions_clear()
```

### Host effect
```text
proof_flow.attempt.suggest({
  fileUri: string,
  nodeId: string
}) -> patch suggestions.byNode.<nodeId>
```

## Ranking Rules (Deterministic)
1. 활성 노드의 최근 에러 카테고리와 동일한 pattern 우선.
2. score 내림차순.
3. sampleSize 내림차순.
4. tacticKey 오름차순(동률 해소).

## Test-First Acceptance
- Domain:
  - `attempt_suggest`가 effect를 1회 호출하고 상태 루트를 깨지지 않는다.
- Host:
  - 동일 입력에서 항상 동일 순서의 추천 결과를 만든다.
  - sample 부족(예: `< 3`) 패턴은 제외한다.
- Projection:
  - selected node가 있을 때 추천 리스트를 노출한다.
  - 추천이 없을 때 empty 상태를 반환한다.
- Extension E2E:
  - command/panel trigger -> `attempt_suggest` 디스패치 검증.

## Implementation Order
1. `packages/schema/domain.mel` 계약 추가
2. `packages/host` effect 구현 + 단위 테스트
3. `packages/app/src/projection-state.ts` selector 확장 + 테스트
4. `packages/app/src/extension.ts`, `packages/app/src/webview-panel.ts` 연결 + E2E
5. 전체 검증: `pnpm test && pnpm typecheck && pnpm build && pnpm test:smoke:vscode`

## Risks / Escalation
- Manifesto core의 dynamic patch path 안정성 이슈가 재현되면 `manifesto-ai/core#108` 기준으로 즉시 에스컬레이션.
- head resume 계약이 필요한 시점에는 `manifesto-ai/core#109` 상태 확인 후 적용 범위 결정.
